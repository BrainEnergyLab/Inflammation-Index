# Inflammation Index R Package
---

## Setup

---

### Step 1: Installation

In R the InflammationIndex package can be installed first by
installing and loading devtools to enable installing packages directly from GitHub, 
then installing the InflammationIndex package from GitHub

```{r, eval = False}
require(devtools)
install_github("BrainEnergyLab/Inflammation-Index/R Package")
```

Then load in the package.

```{r}
require(InflammationIndex)
```

---

## Use with the Microglia Morphology Analysis Fiji Plugin

---

### Step 2: Loading in Data (morphPreProcessing() function)

After users have run the Microglia Morphology Analysis Fiji plugin,
the morphPreProcessing() function can be used to read in and collate all the morphological
metrics extracted.This function requires users to specify:
- pixelSize: The pixel size in microns (assuming a square pixel)
- morphologyWD: The file path to the 'Output' folder of the 'working directory' of the Fiji plugin passed as a string 
- animalIDs: A string vector where each element is the ID of an animal that users want to extract data for
- treatmentIDs: A string vector where each element is the ID of the treatment applied that users want to extract data for

Optional inputs:
- TCSExclude: a numeric vector of mask size values that users want to exclude from the data collation
  - Defaults to NULL (no values are excluded)
- useFrac: a boolean that indicates whether the user wants to include data from FracLac in their collation
  - Defaults to False

The output of the function is a data.table where each row is a cell and the columns indicate
morphological metrics.

```{r}
pixelSize = 0.58 # Pixel size in microns
morphologyWD = "/Microglial Morphology/Output" # Output directory of the MicroMorph.ijm script as a string
animalIDs = c('HIPP5', 'HIPP6', 'HIPP7') # Vector of strings identifying the names of the animals images were captured from and matching the names of the Animal level folders
treatmentIDs = c('Pre-LPS', 'Post-LPS') # Vector of strings identifying different treatments / timepoints and matching the names of the Treatment level folders
useFrac = T # Boolean indicating whether to use the output of the FracLac plugin
TCSExclude = NULL # String vector of mask sizes to exclude from the preprocessing function, can also take NULL
```

#### Retrieving animal and treatment IDs from the Fiji plugin folder structure

To avoid having to manually input the animal and treatment IDs, users can use the
getAnimalAndTreatmentIDs() function to return a list, the only input is:
- imageStorageDirectory: the file path to the 'image storage directory' that users used with the
Fiji plugin, passed as a string

The function returns a list with two elements:
- treatmentIDs: a string vector of treatment IDs
- animalIDs: a string vector of animal IDs
These can be passed directly to the treatmentIDs and animalIDs arguments in morphPreProcessing().

```{r include = False}

imageStorageDirectory = '/Users/devin.clarke/Google Drive/Microglia Morphology Analysis Plugin - ImageJ Example Directory and Input Data; Plugin Run Complete/Image Storage Directory/'
morphologyWD = '/Users/devin.clarke/Google Drive/Microglia Morphology Analysis Plugin - ImageJ Example Directory and Input Data; Plugin Run Complete/Working Directory/Output'

imageStorageDirectoryOld = '/Users/devin.clarke/Dropbox (Brain Energy Lab)/Everything/2P data/Devin/'
morphologyWDOld = '/Users/devin.clarke/Dropbox (Brain Energy Lab)/Everything/Devin/2P Data Analysis/Microglial Morphology/Output/'

exampleData = '/Users/devin.clarke/Google Drive/Inflammation Index R Package Example Data/example_morphpreprocessing_output.csv'

```

Here we're using the 'Image Storage Directory' in the example data found at our [Fji example data directory](https://drive.google.com/drive/folders/1axi8uFPbbyMObYko62jP14De9DCrQeUT?usp=sharing)

```{r}

idList = getAnimalAndTreatmentIDs(imageStorageDirectory)
treatmentIDs = idList$treatmentIDs
animalIDs = idList$animalIDs

idList

```

Here we're using the 'Working Directory' in the example data found at our [Fji example data directory](https://drive.google.com/drive/folders/1axi8uFPbbyMObYko62jP14De9DCrQeUT?usp=sharing)

```{r}
output = 
  morphPreProcessing(
    pixelSize = pixelSize, morphologyWD = morphologyWD, 
    animalIDs = animalIDs, treatmentIDs = treatmentIDs,
    useFrac = useFrac)
```

The colums in the output table:
- Animal: animal ID 
- Treatment: treatment ID
- TCSValue:  The mask size value this row's metrics relate to
- UniqueID is a unique identifier for each row (a combination of animal, treatment, mask size, and name of the mask file)
- CellNo (second to last column) is an identifier for each cell that is duplicated if a cell
has measurements taken at multiple TCSValue levels. 

All other columns are morphological metrics.

```{r}
head(output)
```

### Step 3: Constructing the Inflammation Index (constructInfInd() function)

Once users have an output from the morphPreProcessing() function, they can use this
to generate an inflammation index based on training conditions using the constructInfInd() function.
This function takes three required arguments:
- inDat: this is the filtered data.table output by the morphPreProcessing() function that is limited to your positive control / training conditions in the 'Treatment' column
  - This table should have two unique values in the 'Treatment' column
  - This table should have multiple 'TCSValue' values as the function compares TCS value against one another
  to pick the value that provides the best morphological discrimination between training conditions
- method: this is a string identifying which method users want to use to optimise the Inflammation Index
  -'p value' uses the smallest p value
  -'AUC' uses a ROC-AUC analysis
  
In addition there is one optional argument:
- noDesc: this is an integer vector of the number of 'best' descriptors to compare to one another
  - Defaults to 5:15
- labCols: this is a string vector containing the names of non-metric columns that defaults to the identifier columns provided by morphPreProcessing():
  - Animal, Treatment, TCSValue, UniqueID, CellNo
  
The function returns a single PCA object.

```{r}
LPSGroups = c('D56', 'LPS')
inDat = output[, Treatment %in% LPSGroups] # The output of the morphPreProcessing() function
method = 'p value' # The method to use to refine the inflammation index, can also take the value 'AUC
```

Here we're going to run this function on the example morphPreProccessing output table
found [here](https://drive.google.com/file/d/1dtgZZuBTPg-uJaWxZy8bOav8mSJs-msY/view?usp=sharing). 
It's worth noting that this data was collated with a legacy version of the morphPreProcessing function
and so has slightly different column names and ID column values.

```{r include = False}

inDat = fread(exampleData)
setnames(inDat, old = c('TCS'), new = 'TCSValue')

```

```{r}

head(inDat[Treatment %in% c('D56', 'LPS'), ])

```
The constructInfInd() function will print out the mask size, and number of descriptors,
that created the Inflammation Index that was most sensitive to the differences in morphology
between the LPSGroups conditions according to the method passed in the method argument. It will
print the value from the method argument.

```{r}
infIndOut = 
  constructInfInd(inDat = inDat[Treatment %in% c('D56', 'LPS')],
                  method = 'p value')
```

### Step 4: Apply the Inflammation Index to test data (apply_inf_ind())

Users can use the apply_inf_ind() function to generate an Inflammation Index for novel
data using the PCA object output by constructInfInd(). All this dataset need to have is the same
metrics that were available in the training dataset. The value of the Inflammation Index for
each cell is added as the column 'InfInd'.

```{r}
data_with_inf_index = apply_inf_ind(infIndOut, inDat)
head(data_with_inf_index[, list(TCS, Animal, Treatment, UniqueID, CellNo, InfInd)])
```

